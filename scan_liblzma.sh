#!/bin/bash

check_liblzma() {
    # Find path to sshd
    sshd_path=$(whereis -b sshd | awk '{print $2}')

    # Find path to liblzma used by sshd
    ldd_output=$(ldd "$sshd_path")
    liblzma_path=$(echo "$ldd_output" | awk '/liblzma/ {print $3}')

    if [ -z "$liblzma_path" ]; then
        echo "Probably not vulnerable (liblzma not found)"
        return
    fi

    # Check for function signature
    echo -e "\nChecking for function signature in liblzma..."
    if hexdump -e '/1 "%02x"' "$liblzma_path" | grep -q 'f30f1efa554889f54c89ce5389fb81e7000000804883ec28488954241848894c2410'; then
        echo "Function signature in liblzma: VULNERABLE"
    else
        echo "Function signature in liblzma: OK"
    fi
}

check_xz_version() {
    # Check xz version
    xz_version_output=$(xz --version | head -n 1)
    xz_version=$(echo "$xz_version_output" | awk '{print $4}')

    pwn_version="5.6.0"
    echo -e "\nChecking xz version..."
    if [ "$(echo -e "$xz_version\n$pwn_version" | sort -V | head -n 1)" == "$pwn_version" ]; then
        echo "xz version $xz_version: VULNERABLE"
    else
        echo "xz version $xz_version: OK"
    fi
}

main() {
    echo "Checking system for CVE-2024-3094 Vulnerability..."
    echo "https://nvd.nist.gov/vuln/detail/CVE-2024-3094"
    echo
    check_liblzma
    check_xz_version
}

main
