#!/usr/bin/env ruby
# CVE-2024-3094-checker.rb
# Quick and dirty PoC for checking whether a vulnerable version of xz-utils is installed
# https://nvd.nist.gov/vuln/detail/CVE-2024-3094
# Author: Baroni Fabio

# This Ruby script is provided as-is and without warranty of any kind, express or implied.
# By executing this script, you acknowledge that you do so at your own risk.
# The author(s) of this script shall not be liable for any damages or issues that may arise from its use, including but not limited to data loss, system instability, or any other unintended consequences.
# It is recommended to review the script and understand its functionality before running it, and to ensure that appropriate backups are in place.
# Use of this script implies your acceptance of these terms.

def execute_command(command)
  `#{command}`
end

def is_vulnerable_version_installed
  pkg_manager = if system('command -v apt-get &>/dev/null')
                  "apt-get"
                elsif system('command -v yum &>/dev/null')
                  "yum"
                elsif system('command -v zypper &>/dev/null')
                  "zypper"
                else
                  puts "Unsupported package manager. Exiting."
                  exit 1
                end

  if pkg_manager == "zypper"
    version = execute_command("rpm -q xz")
    if version =~ /(5\.6\.(0|1))/
      puts "It seems you have a vulnerable version of the xz package installed on your system"
      puts "OpenSuse has released a patched version that avoids this CVE, running zypper to update the xz package..."
      system("sudo zypper refresh")
      system("sudo zypper update xz")
      if $?.exitstatus == 0
        puts "xz package updated successfully. Now it is advisable to reboot"
      else
        puts "xz package update failed"
      end

      if `lsb_release -d`.include?("Tumbleweed")
        puts "OpenSuse recommends openSUSE Tumbleweed users where SSH is exposed to the internet to make a fresh installation of the system and change credentials, as itâ€™s unknown if the backdoor has been exploited."
        puts "Due to the sophisticated nature of the backdoor an on-system detection of a breach is likely not possible."
        puts "Also rotation of any credentials that could have been fetched from the system is highly recommended."
      end
    else
      puts "Your OpenSuse installation is probably safe."
    end
  elsif pkg_manager == "apt-get"
    version = execute_command("dpkg -l | grep 'xz-utils' | awk '{print $3}'")
    if version.include?("5.6.0") || version.include?("5.6.1")
      puts "Vulnerable version of xz-utils found: #{version}"
      print "Do you want to attempt installing the stable uncompromised xz-utils 5.4.6 version from source? (y/n): "
      choice = gets.chomp
      if choice.downcase == "y"
        puts "Downloading xz-utils 5.4.6 from source..."
        `wget https://github.com/tukaani-project/xz/releases/download/v5.4.6/xz-5.4.6.tar.gz`
        `tar -zxvf xz-5.4.6.tar.gz`
        Dir.chdir("xz-5.4.6") do
          puts "Configuring xz-utils..."
          system("./configure")
          puts "Compiling xz-utils..."
          system("make")
          puts "Installing xz-utils..."
          system("sudo make install")
          puts "xz-utils 5.4.6 installed successfully."
        end
      else
        puts "You chose not to install the package automatically. Install manually if needed. Exiting."
      end
    else
      puts "You appear to be safe."
    end
  end
end

is_vulnerable_version_installed
