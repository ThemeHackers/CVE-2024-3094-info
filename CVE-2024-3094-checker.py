#!/usr/bin/env ruby
# CVE-2024-3094-detect.rb

# Original script:
# https://www.openwall.com/lists/oss-security/2024/03/29/4

# Modified (fixed and features added) by cyclone
# https://github.com/cyclone-github/scripts/blob/main/xz_cve-2024-3094-detect.rb

# Tested on Debian

# https://nvd.nist.gov/vuln/detail/CVE-2024-3094
# https://github.com/advisories/GHSA-rxwq-x6h5-x525

# v1.0.0; 2024-03-29

def check_vulnerability
  puts "Checking system for CVE-2024-3094 Vulnerability..."
  puts "https://nvd.nist.gov/vuln/detail/CVE-2024-3094"

  # Find path to liblzma used by sshd
  sshd_path = `whereis -b sshd | awk '{print $2}'`.strip
  path = `ldd "#{sshd_path}" 2>/dev/null | grep liblzma | awk '{print $3}' | head -n 1`.strip

  if path.empty?
    puts "\nProbably not vulnerable (liblzma not found)"
    exit
  end

  # Check for function signature
  signature = "f30f1efa554889f54c89ce5389fb81e7000000804883ec28488954241848894c2410"
  puts "\nChecking for function signature in liblzma..."
  if `hexdump -ve '1/1 "%.2x"' "#{path}" | grep -q '#{signature}'`
    puts "Function signature in liblzma: VULNERABLE"
  else
    puts "Function signature in liblzma: OK"
  end

  # Check xz version
  xz_version = `xz --version | head -n1 | awk '{print $4}'`.strip
  pwn_version = "5.6.0"
  puts "\nChecking xz version..."
  if xz_version.split(".").map(&:to_i) >= pwn_version.split(".").map(&:to_i)
    puts "xz version #{xz_version}: VULNERABLE"
  else
    puts "xz version #{xz_version}: OK"
  end
end

check_vulnerability
